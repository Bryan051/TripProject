<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400&display=swap"
	rel="stylesheet">
<link href="./resources/css/plan.css" rel="stylesheet">
<script
	src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=L9YT0x6My9adXfumw1zGi2Gs24KLX3qS7depPI37"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">

//영수증인증 팝업창
function openPopup() {
    var popupContainer = document.createElement("div");
    popupContainer.setAttribute("id", "ocr_popupContainer");
    popupContainer.setAttribute("class", "ocr_popup-container");
    
    var popup = document.createElement("div");
    popup.setAttribute("class", "ocr_popup");
    
    // 팝업 내용 추가
    popup.innerHTML = `
        <h1>영수증 인증</h1>
        <form action="/review/reveiwwrite" method="post" enctype="multipart/form-data">
            <div class="filebox">
                <input type="file" id="attachFile" name="attachFile" onchange="readURL(this);">
                <input type="submit" value="인증하기" id="submitBT">
                <br>
                <img id="preview" />
                <input type="hidden" name="placeNumber" value="" id="placeNumber">
            </div>
        </form>
        <span class="ocr_popup-close" onclick="closePopup()">X</span>
    `;
    
    popupContainer.appendChild(popup);
    document.body.appendChild(popupContainer);
}

function closePopup() {
    var popupContainer = document.getElementById("ocr_popupContainer");
    if (popupContainer) {
        popupContainer.parentNode.removeChild(popupContainer);
    }
}

// 파일 미리보기 함수
function readURL(input) {
    var session = sessionStorage.getItem('placeNumber');
    document.getElementById("placeNumber").value = session;
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        document.getElementById('preview').src = "";
    }
}


var loginchk = [[${session.login}]];
console.log(loginchk);
var markers = []; // 마커를 담을 배열
var placeData=[];
var map; // map 객체 선언
// 초기 마커 생성
var placeList = [[${placeRestaurantList}]];

function initTmap() {
	  // map 생성
	  map = new Tmapv2.Map("map_div", {
	    center: new Tmapv2.LatLng(33.3616666, 126.5291666),
	    width: "60vw", // 지도의 넓이
	    height: "80vh", // 지도의 높이
	    zoom: 10
	  });
	  createMarkers(placeList);
	}

function fetchUpdatedMarkers(category) {
	
    $.ajax({
      url: '/plan/fetchMarkers',
      method: 'GET',
      data: { category: category },
      success: function (data) {
    	  createMarkers(data);
    	  updateList(data);
      },
      error: function () {
        console.log('Failed to fetch updated markers.');
      }
    });
  }
  
function updateList(data) {
	  // 리스트를 업데이트하는 작업 수행
	  var listContainer = document.querySelector('.list');
	  listContainer.innerHTML = ''; // 기존 리스트 내용 초기화

	  // data를 기반으로 새로운 리스트 아이템 생성
	  data.forEach(function (item) {
	    var listItem = document.createElement('div');
	    listItem.id = 'list-item';

	    // 리스트 아이템 내용 생성 및 추가
	    // 예시: 아이템의 이름은 item.name으로 가정
	    var itemName = document.createElement('h3');
	    itemName.textContent = item.name;
	    listItem.appendChild(itemName);

	    // 리스트 컨테이너에 새로운 리스트 아이템 추가
	    listContainer.appendChild(listItem);
	  });
	}
var selectedMarkerChart1 = null; // 클릭된 마커에 대한 차트 인스턴스를 저장할 변수 (chartCanvas)
var selectedMarkerChart2 = null; // 클릭된 마커에 대한 차트 인스턴스를 저장할 변수 (chartCanvas2)

function createMarkers(data) {
    // 이전에 생성된 마커 삭제
    // 숨길 요소와 나타낼 요소를 변수로 저장
	var mainLeft = document.getElementsByClassName("main-left")[0];
	var placeMenu = document.getElementsByClassName("placemenu")[0];
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    }
    markers = [];
	placeData = [];
    // 새로운 마커 생성
    for (var i = 0; i < data.length; i++) {
      var place = data[i];
      var marker = new Tmapv2.Marker({
        position: new Tmapv2.LatLng(place.placeLon, place.placeLat),
        map: map,
        title: place.placeName
      });
      
      marker.setIcon("/resources/image/mk.png");
      markers.push(marker); // 생성된 마커를 배열에 추가
      
      var extractedValue2 = {
    		placeNumber: place.placeNumber,
      		placeName: place.placeName,
      		placeAddress: place.placeAddress,
      		placePhone: place.placePhone,
      		placeGood: place.placeGood,
      		placeInfo: place.placeInfo,
      		placeTag1: place.placeTag1,
      		placeTag2: place.placeTag2,
      		placeTag3: place.placeTag3
            };
      placeData.push(extractedValue2);
    }
    var selectedMarker = null; // 클릭된 마커를 저장할 변수 추가
    
    document.getElementById("placemenu_button").onclick = function () {
    	mainLeft.style.display = 'block';
	      placeMenu.style.display = 'none';
	      if (selectedMarker !== null) {
                selectedMarker.setIcon("/resources/image/mk.png");
          }
      };
    // 마커 클릭 이벤트 등록
    for (var i = 0; i < markers.length; i++) {
	  (function(index) {
	    markers[index].addListener("click", function(evt) {
	    	      var marker = markers[index];
	      var placedata = placeData[index];
	      var placeNumber = placedata.placeNumber;
	      console.log(marker);
	      console.log(placedata);
	   	  // 이전에 클릭된 마커가 있을 경우 아이콘을 원래대로 되돌림
          if (selectedMarker !== null) {
                selectedMarker.setIcon("/resources/image/mk.png");
          }
	      
       // 이전에 클릭된 마커에 대한 차트를 파괴
          if (selectedMarkerChart1 !== null) {
            selectedMarkerChart1.destroy();
          }
          if (selectedMarkerChart2 !== null) {
            selectedMarkerChart2.destroy();
          }
       
        sessionStorage.setItem('placeNumber', placedata.placeNumber);
	      marker.setIcon("/resources/image/m11.png");
	      
	      // 요소의 스타일 속성을 조작하여 나타내거나 숨김
	      mainLeft.style.display = 'none';
	      placeMenu.style.display = 'block';
	      
	      document.getElementById("datatest1").innerText = placedata.placeName;
	      document.getElementById("datatest2").innerText = placedata.placeAddress;
	      document.getElementById("datatest3").innerText = placedata.placePhone;
	      document.getElementById("datatest4").innerText = placedata.placeGood;
	      document.getElementById("datatest5").innerText = placedata.placeInfo;
	      document.getElementById("datatest6").innerText = placedata.placeTag1;
	      document.getElementById("datatest7").innerText = placedata.placeTag2;
	      document.getElementById("datatest8").innerText = placedata.placeTag3;
	      
	   	  // 클릭된 마커를 selectedMarker 변수에 저장
        selectedMarker = marker;
	   	console.log("click :"+placeNumber);
	   	selectedMarkerChartId = "chart" + index;  // 각 마커에 대한 고유한 ID 생성
	      
        
        $.ajax({
						    url: '/plan/genderList',
						    type: 'GET',
						    data: { recommandPlaceNumber : placeNumber },
						    success: function(data2){
						    	var count1 = data2[0].count;
					            var count2 = data2[1].count;
						    	console.log(data2[0].count);
						    	console.log(data2[1].count);
						    	
						    	var total = count1 + count2;
						    	  var ratio1 = count1 / total;
						    	  var ratio2 = count2 / total;
						    	  
						    	  var percentage1 = (ratio1 * 100).toFixed(2) + "%";
						    	  var percentage2 = (ratio2 * 100).toFixed(2) + "%";

						    	  var ctx = document.getElementById("chartCanvas").getContext("2d");
						    	  if (selectedMarkerChart1) {
						              selectedMarkerChart1.destroy();
						            }
						            selectedMarkerChart1 =new Chart(ctx, {
						    	    type: 'pie',
						    	    data: {
						    	      labels: ["여성 (" + percentage1 + ")", "남성 (" + percentage2 + ")"],
						    	      datasets: [{
						    	        data: [ratio1, ratio2],
						    	        backgroundColor: ['#FF6384', '#36A2EB'],
						    	        borderWidth: 1
						    	      }]
						    	    },
					                options: {
					                  responsive: true
					                }
					              });
					            },
					            error: function (xhr, status, error) {
					              console.error(error);
					            }
					          });
				      $.ajax({
						    url: '/plan/birthList',
						    type: 'GET',
						    data: { recommandPlaceNumber : placeNumber },
						    success: function(data3){
						    	var ageCategories = {
						    		      "10대": 0,
						    		      "20대": 0,
						    		      "30대": 0,
						    		      "40대": 0,
						    		      "50대": 0,
						    		      "60대": 0
						    		    };
						    	for(var i=0;i<data3.length;i++){
						    		var birthYear = parseInt(data3[i].userBirth);
						    	      var age = new Date().getFullYear() - birthYear + 1;

						    	      if (age >= 10 && age < 20) {
						    	        ageCategories["10대"]++;
						    	      } else if (age >= 20 && age < 30) {
						    	        ageCategories["20대"]++;
						    	      } else if (age >= 30 && age < 40) {
						    	        ageCategories["30대"]++;
						    	      } else if (age >= 40 && age < 50) {
						    	        ageCategories["40대"]++;
						    	      } else if (age >= 50 && age < 60) {
						    	        ageCategories["50대"]++;
						    	      } else {
						    	        ageCategories["60대"]++;
						    	      }
						    	}
						    	var ctx = document.getElementById("chartCanvas2").getContext("2d");
						    	if (selectedMarkerChart2) {
						              selectedMarkerChart2.destroy();
						            }
						            selectedMarkerChart2 = new Chart(ctx, {
						    	      type: 'bar',
						    	      data: {
						    	        labels: Object.keys(ageCategories).map(function(label) {
						    	          return label + "(" + ageCategories[label] + "명)";
						    	        }),
						    	        datasets: [{
						    	          label: '연령대 비율',
						    	          data: Object.values(ageCategories),
						    	          backgroundColor: 'rgba(0, 123, 255, 0.7)',
						    	          borderColor: 'rgba(0, 123, 255, 1)',
						    	          borderWidth: 1
						    	        }]
						    	      },
						    	      options: {
						    	        responsive: true,
						    	        scales: {
						    	          y: {
						    	            beginAtZero: true,
						    	            ticks: {
						    	              stepSize: 1,
						    	              callback: function(value) {
						    	                return value.toString();
						    	              }
						    	            }
						    	          },
						    	          x: {
						    	            grid: {
						    	              display: false
						    	            }
						    	          }
						    	        },
						    	        plugins: {
						    	          legend: {
						    	            display: false
						    	          },
						    	          tooltip: {
						    	            callbacks: {
						    	              label: function(context) {
						    	                var label = context.label || '';
						    	                var value = context.parsed.y || 0;
						    	                return label + ': ' + value;
						    	              }
						    	            }
						    	          }
						    	        }
						    	      }
						    	    });
						    	  },
					            error: function (xhr, status, error) {
					              console.error(error);
					            }
					          });
	    });
	  })(i);
	}
  }
  document.addEventListener('DOMContentLoaded', function () {
    var restaurantBtn = document.getElementById('restaurant-btn');
    restaurantBtn.addEventListener('click', function () {
      fetchUpdatedMarkers('restaurant');
    });

    var youtubeBtn = document.getElementById('youtube-btn');
    youtubeBtn.addEventListener('click', function () {
      fetchUpdatedMarkers('youtube');
    });

    var touristBtn = document.getElementById('tourist-btn');
    touristBtn.addEventListener('click', function () {
      fetchUpdatedMarkers('tourist');
    });

    var hillBtn = document.getElementById('hill-btn');
    hillBtn.addEventListener('click', function () {
      fetchUpdatedMarkers('hill');
    });

    var ollegilBtn = document.getElementById('ollegil-btn');
    ollegilBtn.addEventListener('click', function () {
      fetchUpdatedMarkers('ollegil');
    });
    
	
	var plusElements = document.querySelectorAll('#list-plus');
	plusElements.forEach(function(plus) {
		  plus.addEventListener('click', function() {
			// 클릭 이벤트 발생 시 실행되는 함수
			    // 클릭한 plus 요소의 부모인 main-left div를 찾아 복사
			    var mainLeft = this.parentNode;
			    var coursePlan = document.querySelector('.course-plan');

			    // main-left div 복사
			    var clonedMainLeft = mainLeft.cloneNode(true);

			    // main-left div 내의 minus 이미지 클릭 시 삭제 이벤트 추가
			    var minus = clonedMainLeft.querySelector('#list-minus');
			    /* minus.addEventListener('click', function() {
			      // minus 이미지 클릭 시 실행되는 함수
			      // 해당 main-left div를 삭제
			      coursePlan.removeChild(clonedMainLeft);
			    }); */

			    // course-plan div에서 기존의 list div를 찾아 가져옴
			    var listContainer = coursePlan.querySelector('.list');

			    // 복사한 main-left div에서 plus 이미지를 제거
			    var plusElement = clonedMainLeft.querySelector('#list-plus');
			    plusElement.remove();
			    
			 	// list-name-heartimg 요소 제거
			    var listNameHeartImg = clonedMainLeft.querySelector('#list-name-heartimg');
			    listNameHeartImg.remove();
			    
			    var listMinusDiv = document.createElement('div');
			    listMinusDiv.setAttribute('id', 'list-minus');

			    // list-minus 이미지 생성
			    var listMinusImg = document.createElement('img');
			    listMinusImg.setAttribute('src', './resources/image/minus.png');
			    listMinusImg.setAttribute('alt', '');

			    // list-minus 이미지를 list-minus div에 추가
			    listMinusDiv.appendChild(listMinusImg);

			    // 복사한 main-left div에 list-minus div 추가
			    clonedMainLeft.appendChild(listMinusDiv);

			    // 가져온 list div에 복사한 main-left div 추가
			    listContainer.appendChild(clonedMainLeft);
		});
	});
  });
	let nowMonth = new Date(); // 현재 달을 페이지를 로드한 날의 달로 초기화
	let today = new Date(); // 페이지를 로드한 날짜를 저장
	today.setHours(0, 0, 0, 0); // 비교 편의를 위해 today의 시간을 초기화

	// 달력 생성 : 해당 달에 맞춰 테이블을 만들고, 날짜를 채워 넣는다.
	function buildCalendar() {

		let firstDate = new Date(nowMonth.getFullYear(), nowMonth.getMonth(), 1); // 이번달 1일
		let lastDate = new Date(nowMonth.getFullYear(),
				nowMonth.getMonth() + 1, 0); // 이번달 마지막날

		let tbody_Calendar = document.querySelector(".Calendar-table > tbody");
		document.getElementById("calYear").innerText = nowMonth.getFullYear(); // 연도 숫자 갱신
		document.getElementById("calMonth").innerText = leftPad(nowMonth
				.getMonth() + 1); // 월 숫자 갱신

		while (tbody_Calendar.rows.length > 0) { // 이전 출력결과가 남아있는 경우 초기화
			tbody_Calendar.deleteRow(tbody_Calendar.rows.length - 1);
		}

		let nowRow = tbody_Calendar.insertRow(); // 첫번째 행 추가           

		for (let j = 0; j < firstDate.getDay(); j++) { // 이번달 1일의 요일만큼
			let nowColumn = nowRow.insertCell(); // 열 추가
		}

		for (let nowDay = firstDate; nowDay <= lastDate; nowDay.setDate(nowDay
				.getDate() + 1)) { // day는 날짜를 저장하는 변수, 이번달 마지막날까지 증가시키며 반복  

			let nowColumn = nowRow.insertCell(); // 새 열을 추가하고
			nowColumn.innerText = leftPad(nowDay.getDate()); // 추가한 열에 날짜 입력

			if (nowDay.getDay() == 0) { // 일요일인 경우 글자색 빨강으로
				nowColumn.style.color = "#DC143C";
			}
			if (nowDay.getDay() == 6) { // 토요일인 경우 글자색 파랑으로 하고
				nowColumn.style.color = "#0000CD";
				nowRow = tbody_Calendar.insertRow(); // 새로운 행 추가
			}

			if (nowDay < today) { // 지난날인 경우
				nowColumn.className = "pastDay";
			} else if (nowDay.getFullYear() == today.getFullYear()
					&& nowDay.getMonth() == today.getMonth()
					&& nowDay.getDate() == today.getDate()) { // 오늘인 경우           
				nowColumn.className = "today";
				nowColumn.onclick = function() {
					choiceDate(this);
				}
			} else { // 미래인 경우
				nowColumn.className = "futureDay";
				nowColumn.onclick = function() {
					choiceDate(this);
				}
			}
		}
	}

	// 날짜 선택
	function choiceDate(nowColumn) {
		if (document.getElementsByClassName("choiceDay")[0]) { // 기존에 선택한 날짜가 있으면
			document.getElementsByClassName("choiceDay")[0].classList
					.remove("choiceDay"); // 해당 날짜의 "choiceDay" class 제거
		}
		nowColumn.classList.add("choiceDay"); // 선택된 날짜에 "choiceDay" class 추가
	}

	// 이전달 버튼 클릭
	function prevCalendar() {
		nowMonth = new Date(nowMonth.getFullYear(), nowMonth.getMonth() - 1,
				nowMonth.getDate()); // 현재 달을 1 감소
		buildCalendar(); // 달력 다시 생성
	}
	// 다음달 버튼 클릭
	function nextCalendar() {
		nowMonth = new Date(nowMonth.getFullYear(), nowMonth.getMonth() + 1,
				nowMonth.getDate()); // 현재 달을 1 증가
		buildCalendar(); // 달력 다시 생성
	}

	// input값이 한자리 숫자인 경우 앞에 '0' 붙혀주는 함수
	function leftPad(value) {
		if (value < 10) {
			value = "0" + value;
			return value;
		}
		return value;
	}
	window.onload = function () {
		  buildCalendar();
		  initTmap();
		};	
</script>
<title>Insert title here</title>
</head>
<body>
	<div class="header">
		<div class="header-category">
			<label id="label-left-course">코스추천</label> <label
				id="label-left-community">커뮤니티</label> <label id="label-left-chat">채팅방</label>
			<img src="./resources/image/logo.png" alt="" id="logimg"> <label
				id="label-right-login">로그인</label> <label id="label-right-register">회원가입</label>
		</div>
	</div>
	<div class="main"> 
		<div class="main-left">
			<h2>사용자 추천</h2>
			<div class="list">
				<div id="left_block" th:each="restaurant : ${placeRestaurantList}">
					<div id="list-img">
						<img th:src="@{/resources/image/place/__${restaurant.placeName}__.jpg}" alt="">
					</div>
					<div id="list-name">
						<div id="list-name-label">
							<label th:text="${restaurant.placeName}">곽지식당</label>
						</div>
						<div id="list-name-heartimg">
							<div>
								<img src="./resources/image/heart.png" alt="" id="heartimg">
							</div>
							<div id="list-name-heartimg-label">
								<label th:text="${restaurant.placeGood}">456</label>
							</div>
						</div>
					</div>
					<div id="list-plus">
						<img src="./resources/image/plus.png" alt="" id="plus">
					</div>
				</div>
			</div>
			
		</div>
		<div class="placemenu" style="display: none;">
			<div id="placemenu_button">
				<button>x</button>
			</div>
			<div id="placemenu_heart">
				<a href="javascript:void(0);" onclick="openPopup();">추천하기</a>
			</div>
			<div id="datatest1"></div>
			<div id="datatest2"></div>
			<div id="datatest3"></div>
			<div id="datatest4"></div>
			<div id="datatest5"></div>
			<div id="datatest6"></div>
			<div id="datatest7"></div>
			<div id="datatest8"></div>
			<div id="datatest0"></div>
			<div id="chart">
				<canvas id="chartCanvas"></canvas>
			</div>
			<div id="chart2">
				<canvas id="chartCanvas2"></canvas>
			</div>

		</div>

		<div class="main-center">
			<div id="map_div"></div>
			<div id="category-button">
				<button id="restaurant-btn">음식점</button>
				<button id="youtube-btn">유튜브맛집</button>
				<button id="tourist-btn">관광지</button>
				<button id="hill-btn">오름</button>
				<button id="ollegil-btn">올레길</button>
			</div>
		</div>
		<div class="main-right">
			<div class="calendar">
				<table class="Calendar-table">
					<thead>
						<tr>
							<td onClick="prevCalendar();" style="cursor: pointer;">&#60;</td>
							<td colspan="5"><span id="calYear"></span>년 <span
								id="calMonth"></span>월</td>
							<td onClick="nextCalendar();" style="cursor: pointer;">&#62;</td>
						</tr>
						<tr>
							<td>일</td>
							<td>월</td>
							<td>화</td>
							<td>수</td>
							<td>목</td>
							<td>금</td>
							<td>토</td>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<div class="course">
				<div class="course-color">
					<div class="course-color-day">
						<h5>Day1</h5>
					</div>
					<div class="course-color-check">
						<div>
							<h5>마커색상</h5>
						</div>
						<div>
							<label for="chk1"> <input type="checkbox" id="chk1">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle1"></i>
							</label>
						</div>
						<div>
							<label for="chk2"> <input type="checkbox" id="chk2">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle2"></i>
							</label>
						</div>
						<div>
							<label for="chk3"> <input type="checkbox" id="chk3">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle3"></i>
							</label>
						</div>
						<div>
							<label for="chk4"> <input type="checkbox" id="chk4">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle4"></i>
							</label>
						</div>
						<div>
							<label for="chk5"> <input type="checkbox" id="chk5">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle5"></i>
							</label>
						</div>
						<div>
							<label for="chk6"> <input type="checkbox" id="chk6">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle6"></i>
							</label>
						</div>
						<div>
							<label for="chk7"> <input type="checkbox" id="chk7">
								<!--실제로는 글자를 기울이는 태그, 퍼블리셔들이 아이콘담을 때 많이 사용--> <i class="circle7"></i>
							</label>
						</div>
					</div>
				</div>

				<div class="course-plan">
					<div class="list"></div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>